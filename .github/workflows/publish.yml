name: Compile Sing-box Rules
on:
  push:
    paths:
      - 'sing-box/*.list' # 监听 sing-box 文件夹下的 .list 文件变动
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Sing-box
        uses: actions/setup-go@v4
        with:
          # --- 这里是修改后的地方 ---
          go-version: '1.23' # 使用 Go 1.23 版本来编译
          # -------------------------
      - run: go install -v -tags with_quic,with_grpc,with_dhcp,with_wireguard,with_shadowsocksr,with_ech,with_utls,with_clash_api github.com/sagernet/sing-box/cmd/sing-box@latest

      - name: Compile Rule-set
        run: |
          # 进入 sing-box 目录
          cd sing-box
          
          # 编译 proxy.list 为 proxy.srs
          echo "Compiling proxy.list..."
          sing-box rule-set compile --output proxy.srs proxy.list
          
          # 编译 lan.list 为 lan.srs
          echo "Compiling lan.list..."
          sing-box rule-set compile --output lan.srs lan.list

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Auto compile rule-set
          # 提交 sing-box 目录下的 .srs 文件
          file_pattern: 'sing-box/*.srs'

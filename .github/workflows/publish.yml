name: Compile Sing-box Rules
on:
  push:
    paths:
      - 'sing-box/*.list' # 监听 sing-box 文件夹下的 .list 文件变动
  workflow_dispatch:

permissions:
  contents: write # 授予 'git push' 的权限

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23' # 使用 Go 1.23 版本来编译
          
      - name: Install Sing-box
        run: |
          go install -v -tags "with_quic,with_grpc,with_dhcp,with_wireguard,with_shadowsocksr,with_utls,with_clash_api" github.com/sagernet/sing-box/cmd/sing-box@latest

      # --- 
      # vvv 这是修改后的关键步骤 vvv
      # ---
      - name: Compile Rule-set (Dynamic)
        run: |
          # 进入 sing-box 目录
          cd sing-box

          # 循环处理当前目录下的所有 .list 文件
          for list_file in *.list; do
            # 1. 从 "proxy.list" 获取 "proxy"
            basename="${list_file%.list}"
            json_file="${basename}.json"
            srs_file="${basename}.srs"

            echo "--- Processing $list_file -> $json_file -> $srs_file ---"

            # 2. 开始 JSON 文件
            echo '{"version":3,"rules":[' > "$json_file"

            # 3. 读取 .list 文件，使用和你原来完全一样的 awk 逻辑
            #    将 suffix:example.com 转换成 {"domain_suffix":"example.com"},
            #    将 keyword:example 转换成 {"domain_keyword":"example"},
            #    将 1.2.3.4/24 转换成 {"ip_cidr":"1.2.3.4/24"},
            #    将 example.com (或其他) 转换成 {"domain":"example.com"},
            awk -F: '!/^#/ && NF > 0 { \
              if ($1 == "suffix") { printf "{\"domain_suffix\":\"%s\"},", $2 } \
              else if ($1 == "keyword") { printf "{\"domain_keyword\":\"%s\"},", $2 } \
              else if ($0 ~ /^[0-9]/) { printf "{\"ip_cidr\":\"%s\"},", $0 } \
              else { printf "{\"domain\":\"%s\"},", $0 } \
            }' "$list_file" | sed 's/,$//' >> "$json_file" # sed 's/,$//' 删除最后一个多余的逗号
            
            # 4. 关闭 JSON 文件
            echo ']}' >> "$json_file"

            # 5. 编译 .json 到 .srs
            echo "Compiling $json_file into $srs_file..."
            sing-box rule-set compile "$json_file" --output "$srs_file"

            # 6. (可选) 删除临时的 .json 文件，保持目录清洁
            echo "Cleaning up $json_file..."
            rm "$json_file"
            
            echo "--- Finished $list_file ---"
          done
      # --- 
      # ^^^ 修改结束 ^^^
      # ---

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Auto compile rule-set
          # 提交 sing-box 目录下的 .srs 文件 (这个无需改动，会自动匹配所有.srs)
          file_pattern: 'sing-box/*.srs'

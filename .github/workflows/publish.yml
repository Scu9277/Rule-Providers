name: Compile Sing-box Rules
on:
  push:
    paths:
      - 'sing-box/*.list' # 监听 sing-box 文件夹下的 .list 文件变动
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Sing-box
        uses: actions/setup-go@v4
        with:
          go-version: '1.23' # 使用 Go 1.23 版本来编译
          
      - name: Install Sing-box
        run: |
          # 移除了过时的 with_ech 标签
          go install -v -tags "with_quic,with_grpc,with_dhcp,with_wireguard,with_shadowsocksr,with_utls,with_clash_api" github.com/sagernet/sing-box/cmd/sing-box@latest

      - name: Compile Rule-set
        run: |
          # 进入 sing-box 目录
          cd sing-box
          
          # 1. 为 proxy.list 创建一个临时的 JSON 配置文件
          echo '{"type":"local","format":"text","path":"proxy.list"}' > proxy.json
          
          # --- 这里是修改后的地方 ---
          # 2. 使用新命令编译 proxy.list
          #    注意：proxy.json 是作为 [source-path] 参数，而不是 --config 标志
          echo "Compiling proxy.list..."
          sing-box rule-set compile proxy.json --output proxy.srs
          
          # 3. 为 lan.list 创建临时的 JSON 配置文件
          echo '{"type":"local","format":"text","path":"lan.list"}' > lan.json
          
          # 4. 使用新命令编译 lan.list
          echo "Compiling lan.list..."
          sing-box rule-set compile lan.json --output lan.srs
          # -------------------------

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Auto compile rule-set
          # 提交 sing-box 目录下的 .srs 文件
          file_pattern: 'sing-box/*.srs'

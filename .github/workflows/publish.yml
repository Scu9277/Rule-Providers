name: Compile Sing-box Rules
on:
  push:
    paths:
      - 'sing-box/*.list' # 监听 sing-box 文件夹下的 .list 文件变动
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Sing-box
        uses: actions/setup-go@v4
        with:
          go-version: '1.23' # 使用 Go 1.23 版本来编译
          
      - name: Install Sing-box
        run: |
          go install -v -tags "with_quic,with_grpc,with_dhcp,with_wireguard,with_shadowsocksr,with_utls,with_clash_api" github.com/sagernet/sing-box/cmd/sing-box@latest

      # --- 这是根据你提供的文档修改的关键步骤 ---
      - name: Compile Rule-set
        run: |
          # 进入 sing-box 目录
          cd sing-box

          # --- 处理 proxy.list ---
          echo "Preparing proxy.json..."
          # 1. 开始 JSON 文件，使用文档建议的 version 3
          echo '{"version":3,"rules":[' > proxy.json
          
          # 2. 读取 proxy.list，跳过空行和注释
          #    将 suffix:example.com 转换成 {"domain_suffix":"example.com"}
          #    将 keyword:example 转换成 {"domain_keyword":"example"}
          #    将 example.com (或其他) 转换成 {"domain":"example.com"}
          awk -F: '!/^#/ && NF > 0 { \
            if ($1 == "suffix") { printf "{\"domain_suffix\":\"%s\"},", $2 } \
            else if ($1 == "keyword") { printf "{\"domain_keyword\":\"%s\"},", $2 } \
            else { printf "{\"domain\":\"%s\"},", $0 } \
          }' proxy.list | sed 's/,$//' >> proxy.json # sed 's/,$//' 删除最后一个多余的逗号
          
          # 3. 关闭 JSON 文件
          echo ']}' >> proxy.json

          # 4. 编译 proxy.json
          echo "Compiling proxy.json into proxy.srs..."
          sing-box rule-set compile proxy.json --output proxy.srs

          # --- 处理 lan.list ---
          echo "Preparing lan.json..."
          # 1. 开始 JSON 文件
          echo '{"version":3,"rules":[' > lan.json
          
          # 2. 读取 lan.list (规则和上面一样)
          awk -F: '!/^#/ && NF > 0 { \
            if ($1 == "suffix") { printf "{\"domain_suffix\":\"%s\"},", $2 } \
            else if ($1 == "keyword") { printf "{\"domain_keyword\":\"%s\"},", $2 } \
            else { printf "{\"domain\":\"%s\"},", $0 } \
          }' lan.list | sed 's/,$//' >> lan.json
          
          # 3. 关闭 JSON 文件
          echo ']}' >> lan.json
          
          # 4. 编译 lan.json
          echo "Compiling lan.json into lan.srs..."
          sing-box rule-set compile lan.json --output lan.srs

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Auto compile rule-set
          # 提交 sing-box 目录下的 .srs 文件
          file_pattern: 'sing-box/*.srs'
